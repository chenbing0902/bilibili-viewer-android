# 配置 GitHub Actions 自动构建
name: Build APK
on: [push] # 当有代码推送时触发

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Fix apt packages
        run: |
          sudo rm -f /var/lib/apt/lists/lock
          sudo rm -f /var/cache/apt/archives/lock
          sudo rm -f /var/lib/dpkg/lock*
          sudo dpkg --configure -a
          sudo apt-get clean
          sudo apt-get update --fix-missing

      - name: Install dependencies
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git \
            zip \
            unzip \
            openjdk-8-jdk \
            python3-pip \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo-dev \
            cmake \
            libffi-dev \
            libssl-dev \
            gettext \
            libltdl-dev
          python3 -m pip install --user --upgrade pip
          python3 -m pip install --user --upgrade wheel
          python3 -m pip install --user --upgrade Cython==0.29.33
          python3 -m pip install --user --upgrade virtualenv
          python3 -m pip install --user --upgrade buildozer
          
      - name: Setup build environment
        run: |
          sudo mkdir -p /opt/android
          sudo chown $USER:$USER /opt/android
          export ANDROID_HOME=/opt/android
          
      - name: Build with Buildozer
        run: |
          export PATH=$PATH:~/.local/bin/
          export ANDROID_HOME=/opt/android
          buildozer android debug
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: bin/*.apk
          
      - name: Upload build logs if failed
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: .buildozer/logs/* 
